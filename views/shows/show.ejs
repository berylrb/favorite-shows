<%- include('../partials/html-head') %>
<link rel="stylesheet" href="/stylesheets/shows/show.css" />
<%- include('../partials/nav') %>

<main>
  <section class="bg-dark text-secondary px-4">
    <h1 class="show-name">
      <%= apiResult.name %>
    </h1>
    <div class="container py-4">
      <div class="wrapper">
        <div class="container">
      <% if (apiResult.poster_path) { %>
        <img class="poster" src="https://image.tmdb.org/t/p/original/<%= apiResult.poster_path %>" alt="">
      <% } else { %>
        <img class="poster" src="https://images-we-got-pop.imgix.net/website/marketing/movie-placeholder.png?w=300&h=450&fit=clamp&auto=format,compress" alt="">
      <% } %>
        </div>
      </div>
      <div class="description">
          <h2 class="accordion-header" id="headingOne">
              Show Description
          </h2>
            <div class="accordion-body">
              <p class="mt-4"><%= apiResult.overview %></p>
        </div>
      </div>
      <p class="mt-4 fs-4 text-light">Rating: <%= apiResult.vote_average %></p>

      <div class="accordion" id="accordion">
        <div class="accordion-item bg-dark">
          <h2 class="accordion-header" id="headingTwo">
              This show appears in <%= show?.collectedBy.length %> user Queues:
          </h2>
              <% show?.collectedBy.forEach(profile => { %>
                <div class="collector">
                  <a href="/profiles/<%= profile._id %>" class="text-white">
                    <p>
                      <img 
                        src="<%= profile.avatar %>" 
                        alt="<%= profile.name %>'s avatar"
                        class="me-3 rounded-circle"
                        width="50px"
                        height="50px"
                      >
                      <%= profile.name %>
                    </p>
                  </a>
                </div>
              <% }) %>
            </div>
      </div>
    </div>
    <% if (!userHasShow) { %>
    <form 
        class="text-center" 
        action="/shows/<%= apiResult.id %>/addToCollection?_method=PATCH" 
        method="POST"
      >
        <input type="text" name="name" hidden value="<%= apiResult.name %>">
        <input type="text" name="mdbId" hidden value="<%= apiResult.id %>">
        <input 
          type="text" 
          name="imageUrl" 
          hidden 
          value="https://image.tmdb.org/t/p/original/<%= apiResult.poster_path %>"
        >
        <button class="btn btn-primary">
          Add To Collection
        </button> 
      </form>
      <% } %>
    <% if (userHasShow) { %>
      <form 
        class="text-center" 
        action="/shows/<%= apiResult.id %>/removeFromCollection?_method=PATCH" 
        method="POST"
      >
        <button class="btn btn-danger">
          Remove From Collection
        </button>
      </form>
    <% } %>
    
    <div class="container">
      <% if (!userHasReviewed && userHasShow) { %>
        <form action="/reviews/<%= show._id %>" method="POST">
          <div class="mb-3 mt-4">
            <label 
              for="exampleFormControlTextarea1" 
              class="form-label text-light"
            >
              Leave a review:
            </label>
            <textarea 
              name="content" 
              class="form-control" 
              id="exampleFormControlTextarea1" 
              rows="3"
            ></textarea>
            <select 
              name="rating" 
              class="form-select" 
            >
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>        
          </div>
          <button class="btn btn-warning"type="submit">Add Review</button>
        </form> 
      <% } %>
      
      <% if (show?.reviews.length) { %>
        <h2 class="text-light my-3">Reviews:</h2>
        <div 
          class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g1 px-4"
        >
        <% show.reviews.forEach(review => { %>
          <div class="col">
            <div class="card mb-3 bg-secondary">
              <div class="row g-0">

                <div class="col-3">
                  <img 
                    src="<%= review.author.avatar %>" 
                    class="img-fluid rounded-circle ms-2 mt-2" 
                    alt="<%= review.author.name %>'s avatar"
                  >
                </div>
                <div class="col-9">
                  <div class="card-body">
                    <h3 class="card-title text-dark">
                      <a 
                        class="text-dark text-decoration-none" 
                        href="/profiles/<%= review.author._id %>"
                      >
                        <%= review.author.name %>
                      </a>
                    </h3>
                    <p class="card-text text-dark">
                      <%= "ðŸŒŸ".repeat(review.rating) %>
                    </p>
                    <p class="card-text text-dark"><%= review.content %></p>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        <% }) %>
        </div>
      <% } %>
      
    </div>
  </section>
</main>

<%- include('../partials/footer') %>